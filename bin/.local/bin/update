#!/usr/bin/env bash
set -euo pipefail
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:$HOME/.local/bin:$PATH"
export LANG=C
export LC_ALL=C

# ——————————————————————————————————————————————————————————————
# Helpers
# ——————————————————————————————————————————————————————————————
has_cmd() { type -P "$1" >/dev/null 2>&1; }

run_cmd() {
  local desc="$1"
  shift
  printf "\n▶ %s\n" "$desc"
  if "$@"; then
    printf "[ OK ] %s\n" "$desc"
  else
    printf "[FAIL] %s\n" "$desc"
  fi
}

step_if() {
  local desc="$1"
  local cond="$2"
  shift 2
  if eval "$cond" >/dev/null 2>&1; then
    run_cmd "$desc" "$@"
  else
    printf "[SKIP] %s (precondition not met)\n" "$desc"
  fi
}

# ——————————————————————————————————————————————————————————————
# Detection
# ——————————————————————————————————————————————————————————————

# Check for pacman
if ! has_cmd pacman; then
  printf "[ERROR] pacman not found - not an Arch-based system?\n"
  exit 1
fi

# Detect privilege escalator
PRIV_ESCALATOR="sudo"
has_cmd pkexec && PRIV_ESCALATOR="pkexec"

# ——————————————————————————————————————————————————————————————
# Main Update Logic
# ——————————————————————————————————————————————————————————————

# Update system packages
step_if "System Packages (pacman via $PRIV_ESCALATOR)" "true" \
  stdbuf -oL -eL "$PRIV_ESCALATOR" pacman -Syu --noconfirm

# Development Tooling
step_if "Composer" "has_cmd composer" stdbuf -oL -eL composer global update
step_if "Node (fnm)" "has_cmd fnm" stdbuf -oL -eL fnm use lts-latest --install-if-missing
step_if "Rust Binaries" "has_cmd cargo-install-update" stdbuf -oL -eL cargo install-update -a
step_if "Rust Toolchain" "has_cmd rustup" stdbuf -oL -eL rustup update

printf "\nDone.\n"
