#!/usr/bin/env bash
set -euo pipefail
export PATH="/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:$HOME/.local/bin:$PATH"
export LANG=C
export LC_ALL=C

# ——————————————————————————————————————————————————————————————
# Helpers
# ——————————————————————————————————————————————————————————————
has_cmd() { type -P "$1" >/dev/null 2>&1; }

run_cmd() {
  local desc="$1"
  shift
  printf "\n▶ %s\n" "$desc"
  if "$@"; then
    printf "[ OK ] %s\n" "$desc"
  else
    printf "[FAIL] %s\n" "$desc"
  fi
}

step_if() {
  local desc="$1"
  local cond="$2"
  shift 2
  if eval "$cond" >/dev/null 2>&1; then
    run_cmd "$desc" "$@"
  else
    printf "[SKIP] %s (precondition not met)\n" "$desc"
  fi
}

# ——————————————————————————————————————————————————————————————
# Main Update Logic
# ——————————————————————————————————————————————————————————————

# System Packages (Arch Linux)
if has_cmd pacman; then
  if ! has_cmd run0; then
    printf "[ERROR] run0 not found - required for system updates.\n"
    exit 1
  fi
  run_cmd "System Packages (pacman via run0)" \
    stdbuf -oL -eL run0 pacman -Syu --noconfirm
fi

# Development Tooling
step_if "Composer" "has_cmd composer" stdbuf -oL -eL composer global update
step_if "Node (fnm)" "has_cmd fnm" stdbuf -oL -eL fnm use lts-latest --install-if-missing
step_if "Bun Binaries" "has_cmd bun" stdbuf -oL -eL bun update -g
step_if "Rust Binaries" "has_cmd cargo-install-update" stdbuf -oL -eL cargo install-update -a
step_if "Rust Toolchain" "has_cmd rustup" stdbuf -oL -eL rustup update

printf "\nDone.\n"
