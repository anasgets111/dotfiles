#!/usr/bin/env bash
set -e
[[ $EUID -ne 0 ]] && exec sudo bash "$0" "$@"

declare -A C=([g]='\033[32m' [m]='\033[35m' [c]='\033[36m' [b]='\033[1m' [0]='\033[0m')

step() {
  printf "  %bâ†’%b %-50s " "${C[m]}" "${C[0]}" "$1"
  mkdir -p "$(dirname "$1")" && cat > "$1"
  [[ "$1" == *.hook ]] || chmod +x "$1"
  printf "%bâœ“%b\n" "${C[g]}" "${C[0]}"
}

printf "\n%b%bâ•â•â•â•â•â• Reboot Required Setup â•â•â•â•â•â•%b\n\n" "${C[c]}" "${C[b]}" "${C[0]}"

# â€” 1. Notification script ----------------------------------------------------

step /usr/local/bin/notify-reboot-required << 'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail

B="<b>" _B="</b>" C="<code>" _C="</code>" I="<i>" _I="</i>"

if [[ $# -gt 0 ]]; then
  TITLE="System Restart Required"
  LIST_ITEMS=$(printf " â€¢ ${C}%s${_C}<br/>" "$@")
  BODY="${B}The following components were updated:${_B}<br/>"
  BODY="${BODY}${LIST_ITEMS}<br/>${I}A reboot is recommended to apply changes.${_I}"
  CONSOLE="Reboot required due to: $*"
else
  TITLE="Reboot Recommended"
  CONSOLE="Reboot is recommended after system updates."
  BODY="Core system components were updated. Please reboot at your convenience."
fi

if [[ -t 2 ]]; then
  printf '\n\033[1;33mâš \033[0m \033[1m%s\033[0m\n\n' "$CONSOLE" >&2
else
  printf '==> %s\n' "$CONSOLE" >&2
fi

for u in $(loginctl list-users --no-legend | awk '{print $2}'); do
  busctl --machine="$u@.host" --user call \
    org.freedesktop.Notifications /org/freedesktop/Notifications \
    org.freedesktop.Notifications Notify susssasa{sv}i \
    "System Update" 0 system-reboot "$TITLE" "$BODY" 0 \
    3 urgency y 2 \
      category s "device.software-update" \
      resident b true \
    0 &>/dev/null || true
done
SCRIPT

# â€” 2. Check script -----------------------------------------------------------

step /usr/local/bin/check-reboot-required << 'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail

[[ -t 0 ]] && { echo "Pacman hook use only." >&2; exit 1; }

mapfile -t targets
declare -A seen=()
triggers=()

add() { [[ -v "seen[$1]" ]] && return; seen["$1"]=1; triggers+=("$1"); }

kver="$(uname -r)"
pkgbase="/usr/lib/modules/$kver/pkgbase"
[[ -r "$pkgbase" ]] && kernelpkg="$(<"$pkgbase")" || kernelpkg="linux"

[[ ! -d "/usr/lib/modules/$kver" ]] && add "linux (modules removed)"

for t in "${targets[@]}"; do
  case "$t" in
    "$kernelpkg"|linux-lts|linux-zen|linux-hardened|linux-firmware|\
    amd-ucode|intel-ucode|nvidia|nvidia-open|nvidia-dkms|nvidia-lts|\
    mesa|lib32-mesa|systemd*|dbus*|glibc|openssl|wayland|egl-wayland|\
    xf86-video-*|xorg-server*|mkinitcpio*|booster*|dracut*)
      add "$t" ;;
    btrfs-progs) mount -t btrfs | grep -q . && add "$t" ;;
    xfsprogs)    mount -t xfs   | grep -q . && add "$t" ;;
    e2fsprogs)   mount -t ext4  | grep -q . && add "$t" ;;
    cryptsetup)  mount | grep -q "/dev/mapper/" && add "$t" ;;
  esac
done

[[ ${#triggers[@]} -gt 0 ]] && /usr/local/bin/notify-reboot-required "${triggers[@]}"
SCRIPT

# â€” 3. Pacman hook ------------------------------------------------------------

step /etc/pacman.d/hooks/90-reboot-required.hook << 'HOOK'
[Trigger]
Operation = Upgrade
Type = Package
Target = amd-ucode
Target = intel-ucode
Target = btrfs-progs
Target = e2fsprogs
Target = xfsprogs
Target = cryptsetup
Target = linux
Target = linux-lts
Target = linux-hardened
Target = linux-zen
Target = linux-firmware
Target = nvidia
Target = nvidia-open
Target = nvidia-dkms
Target = nvidia-lts
Target = mesa
Target = lib32-mesa
Target = systemd*
Target = dbus*
Target = glibc
Target = openssl
Target = mkinitcpio*
Target = booster*
Target = dracut*
Target = wayland
Target = egl-wayland
Target = xf86-video-*
Target = xorg-server*

[Action]
Description = Checking if reboot is required...
When = PostTransaction
NeedsTargets
Exec = /usr/local/bin/check-reboot-required
HOOK

printf "\n  %b%bğŸ‰ Success!%b Setup complete. Reboot notifications active.\n\n" \
  "${C[g]}" "${C[b]}" "${C[0]}"