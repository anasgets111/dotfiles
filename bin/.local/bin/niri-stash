#!/usr/bin/env bash
set -e

case $1 in
    term)     re='^(kitty|(com\.mitchellh\.)?ghostty|Alacritty|org\.wezfurlong\.wezterm|foot)$'; cmd='xdg-terminal-exec' ;;
    slack)    re='^Slack$'; cmd='slack' ;;
    telegram) re='^org\.telegram\.desktop$'; cmd='Telegram' ;;
    vesktop)  re='^vesktop$'; cmd='vesktop' ;;
    *)        echo "Usage: $0 {term|slack|telegram|vesktop}" >&2; exit 1 ;;
esac

get_ws() { niri msg -j workspaces | jq -r '.[]|select(.is_focused).idx'; }
find_win() { niri msg -j windows | jq -r --arg re "$re" '.[]|select((.title//""|test($re;"i")) or (.app_id//""|test($re;"i")))|"\(.id) \(.is_focused)"' | head -1; }

read -r id focused <<< "$(find_win)" || true

if [[ -z "$id" ]]; then
    ws=$(get_ws)
    niri msg action spawn -- sh -c "$cmd"
    for ((i=0; i<50; i++)); do
        read -r id _ <<< "$(find_win)" || true
        [[ -n "$id" ]] && break
        read -rt 0.1 -N 0 || true
    done
    [[ -n "$id" ]] || exit 1
    niri msg action move-window-to-workspace --window-id "$id" "$ws"
    niri msg action center-floating-window --id "$id" 2>/dev/null || true
    niri msg action focus-window --id "$id"
elif [[ "$focused" == "true" ]]; then
    niri msg action move-window-to-workspace --window-id "$id" --focus=false "stash"
else
    ws=$(get_ws)
    niri msg action move-window-to-workspace --window-id "$id" "$ws"
    niri msg action center-floating-window --id "$id" 2>/dev/null || true
    niri msg action focus-window --id "$id"
fi
