#!/usr/bin/env bash
# setup-greetd.sh — Install and configure the Obelisk greetd greeter
# Run this from anywhere; it detects the greeter source automatically.

set -e

GREETER_SRC="${1:-}"
INSTALL_DIR="/etc/xdg/quickshell/obelisk-greeter"
CACHE_DIR="/var/cache/obelisk-greeter"
GREETD_CONFIG="/etc/greetd/config.toml"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

info() { echo -e "${CYAN}[INFO]${NC} $*"; }
ok() { echo -e "${GREEN}[OK]${NC} $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
err() { echo -e "${RED}[ERROR]${NC} $*" >&2; }

confirm() {
  read -rp "$1 [Y/n] " ans
  [[ -z "$ans" || "$ans" =~ ^[Yy] ]]
}

# ── Find greeter source ─────────────────────────────────────────────────
if [[ -z "$GREETER_SRC" ]]; then
  for dir in \
    "${XDG_CONFIG_HOME:-$HOME/.config}/quickshell/Greeter" \
    "$HOME/.config/quickshell/Greeter"; do
    if [[ -f "$dir/shell.qml" ]]; then
      GREETER_SRC="$dir"
      break
    fi
  done
fi

if [[ -z "$GREETER_SRC" || ! -f "$GREETER_SRC/shell.qml" ]]; then
  err "Cannot find greeter source (shell.qml)."
  err "Pass the path as argument: setup-greetd /path/to/Greeter"
  exit 1
fi

echo ""
echo -e "${CYAN}══════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}    Obelisk Greeter — Setup Script${NC}"
echo -e "${CYAN}══════════════════════════════════════════════════════${NC}"
echo ""
info "Greeter source: $GREETER_SRC"
info "Install target: $INSTALL_DIR"
echo ""

# ── 1. Check/install greetd ─────────────────────────────────────────────
info "Checking for greetd..."
if command -v greetd >/dev/null 2>&1; then
  ok "greetd is installed"
else
  warn "greetd is not installed"
  if command -v pacman >/dev/null 2>&1; then
    if confirm "Install greetd via pacman?"; then
      sudo pacman -S --noconfirm greetd
      ok "greetd installed"
    else
      err "greetd is required. Aborting."
      exit 1
    fi
  else
    err "greetd not found and pacman not available."
    err "Please install greetd manually and re-run this script."
    exit 1
  fi
fi

# ── 2. Check quickshell ─────────────────────────────────────────────────
info "Checking for quickshell (qs)..."
if command -v qs >/dev/null 2>&1; then
  ok "quickshell found: $(which qs)"
else
  err "quickshell (qs) not found in PATH."
  err "Install quickshell-git from AUR or build from source."
  exit 1
fi

# ── 3. Create greeter user ──────────────────────────────────────────────
info "Checking greeter user..."
if id greeter &>/dev/null; then
  ok "greeter user exists"
else
  info "Creating greeter system user..."
  sudo groupadd -r greeter 2>/dev/null || true
  sudo useradd -r -g greeter -d /var/lib/greeter -s /bin/bash -c "System Greeter" greeter 2>/dev/null || true
  sudo mkdir -p /var/lib/greeter
  sudo chown greeter:greeter /var/lib/greeter
  ok "greeter user created"
fi

# ── 4. Deploy greeter folder ────────────────────────────────────────────
info "Deploying greeter to $INSTALL_DIR..."
sudo mkdir -p "$INSTALL_DIR"
sudo cp -r "$GREETER_SRC"/* "$INSTALL_DIR/"
sudo chown -R root:root "$INSTALL_DIR"
sudo chmod -R 644 "$INSTALL_DIR"/*
sudo find "$INSTALL_DIR" -type d -exec chmod 755 {} \;
sudo chmod +x "$INSTALL_DIR/dots-greeter"
ok "Greeter deployed"

# ── 5. Create cache directory ───────────────────────────────────────────
info "Creating cache directory $CACHE_DIR..."
sudo mkdir -p "$CACHE_DIR"
sudo chown greeter:greeter "$CACHE_DIR"
sudo chmod 750 "$CACHE_DIR"
ok "Cache directory ready"

# ── 6. Detect compositor ────────────────────────────────────────────────
COMPOSITOR_FLAG="--detect"
echo ""
info "Which compositor should the greeter use?"
echo "  1) Auto-detect (recommended)"
echo "  2) Niri"
echo "  3) Hyprland"
read -rp "Choice [1]: " choice
case "${choice:-1}" in
2) COMPOSITOR_FLAG="--command niri" ;;
3) COMPOSITOR_FLAG="--command hyprland" ;;
*) COMPOSITOR_FLAG="--detect" ;;
esac

# ── 7. Configure greetd ─────────────────────────────────────────────────
info "Writing greetd config to $GREETD_CONFIG..."
sudo mkdir -p "$(dirname "$GREETD_CONFIG")"

# Backup existing config
if [[ -f "$GREETD_CONFIG" ]]; then
  sudo cp "$GREETD_CONFIG" "${GREETD_CONFIG}.bak"
  warn "Backed up existing config to ${GREETD_CONFIG}.bak"
fi

LAUNCHER="$INSTALL_DIR/dots-greeter"
sudo tee "$GREETD_CONFIG" >/dev/null <<EOF
[terminal]
vt = 1

[default_session]
user = "greeter"
command = "$LAUNCHER $COMPOSITOR_FLAG"
EOF
ok "greetd configured"

# ── 8. Configure PAM (Keyring) ──────────────────────────────────────────
if [[ -f "/usr/lib/security/pam_gnome_keyring.so" ]]; then
  info "Configuring PAM for gnome-keyring..."
  PAM_FILE="/etc/pam.d/greetd"
  # Backup
  [[ ! -f "${PAM_FILE}.bak" ]] && sudo cp "$PAM_FILE" "${PAM_FILE}.bak"

  sudo tee "$PAM_FILE" >/dev/null <<EOF
#%PAM-1.0
auth       required     pam_securetty.so
auth       requisite    pam_nologin.so
auth       include      system-local-login
auth       optional     pam_gnome_keyring.so
account    include      system-local-login
session    include      system-local-login
session    optional     pam_gnome_keyring.so auto_start
EOF
  ok "PAM configured for keyring unlocking"
else
  warn "pam_gnome_keyring.so not found, skipping PAM config"
fi

# ── 9. Enable greetd service ────────────────────────────────────────────
echo ""
if confirm "Enable greetd.service?"; then
  # Disable common DMs
  for dm in gdm sddm lightdm; do
    if systemctl is-enabled "$dm.service" &>/dev/null; then
      warn "Disabling $dm.service..."
      sudo systemctl disable "$dm.service" 2>/dev/null || true
    fi
  done
  # ly uses templated service ly@ttyX
  for ly_svc in $(systemctl list-units --no-legend --type=service 'ly@*' 2>/dev/null | awk '{print $1}'); do
    warn "Stopping and disabling $ly_svc..."
    sudo systemctl disable --now "$ly_svc" 2>/dev/null || true
  done
  sudo systemctl enable greetd.service
  ok "greetd.service enabled"
else
  warn "Skipped enabling greetd.service — enable it manually when ready:"
  echo "    sudo systemctl enable greetd.service"
fi

# ── Summary ──────────────────────────────────────────────────────────────
echo ""
echo -e "${GREEN}══════════════════════════════════════════════════════${NC}"
echo -e "${GREEN}    Setup Complete!${NC}"
echo -e "${GREEN}══════════════════════════════════════════════════════${NC}"
echo ""
echo "  Greeter:  $INSTALL_DIR"
echo "  Cache:    $CACHE_DIR"
echo "  Config:   $GREETD_CONFIG"
echo "  Command:  $LAUNCHER $COMPOSITOR_FLAG"
echo ""
echo "  Next steps:"
echo "    • Reboot to test the greeter"
echo "    • Or test manually: sudo greetd"
echo ""
