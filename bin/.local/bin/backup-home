#!/usr/bin/env bash
set -euo pipefail

BACKUP_DIR="/mnt/Work/Home_backup"
MOUNT_POINT="$(dirname "$BACKUP_DIR")"

# Check if mount exists to prevent filling root partition
if ! mountpoint -q "$MOUNT_POINT"; then
    echo "Error: Backup drive not mounted at $MOUNT_POINT"
    exit 1
fi

EXCLUDES=(
    # Temp/cache files
    '*.tmp' '*.log' '*.bak'
    '*.swp' '*.swo' '*~' '.DS_Store'

    # Dependencies
    'vendor' 'node_modules'

    # Build artifacts
    'target' 'build' 'dist' 'out'

    # Version control
    '.git' '.svn' '.hg'

    # Python
    '__pycache__' '*.pyc' '*.pyo' '.venv' '.tox'

    # IDE/Editor
    '.idea' '.gradle'

    # Misc
    '.next' '.nuxt' 'coverage' '.parcel-cache'

    # Electron/Chromium volatile caches (safe to regenerate)
    # Native installs (~/.config/*)
    '.config/**/Cache/'
    '.config/**/Code Cache/'
    '.config/**/GPUCache/'
    '.config/**/GrShaderCache/'
    '.config/**/ShaderCache/'
    '.config/**/DawnCache/'
    '.config/**/DawnGraphiteCache/'
    '.config/**/DawnWebGPUCache/'
    '.config/**/GraphiteDawnCache/'
    '.config/**/Crashpad/'
    '.config/**/blob_storage/'
    '.config/**/BrowserMetrics/'
    '.config/**/Reporting and NEL/'
    '.config/**/OptimizationHints/'
    '.config/**/VideoDecodeStats/'
    '.config/**/Service Worker/CacheStorage/'
    '.config/**/Service Worker/ScriptCache/'

    # Chromium forks (Antigravity/VS Code/etc.) additional volatile dirs
    '.config/**/CachedData/'
    '.config/**/CachedExtensionVSIXs/'

    # Cache directories
    '.cache'
    '.local/share/Trash'
    '.npm'
    '.nv'
    '.local/share/cargo/registry'
    '_cacache'

    # More cache patterns (within apps - keeps sessions/logins/settings)
    'CachedConfigurations'
    'CachedProfilesData'

    # Gaming (large, re-downloadable)
    '.local/share/Steam'
    '.local/share/umu'
    '.config/heroic/tools'
    '.config/heroic/prefixes'
    '.config/heroic/images-cache'

    # Re-downloadable toolchains/runtimes (large, low-risk to exclude)
    '.rustup'
    '.local/share/containers/storage'
    '.antigravity/extensions'
    '.vscode/extensions'
    '.local/share/zed/external_agents'
    '.local/share/opencode/snapshot'
    '.gemini/tmp'

    # Stow-managed files (home module)
    '.bashrc'
    '.gitconfig'
    '.profile'

    # Stow-managed files (config module)
    '.config/code-flags.conf'
    '.config/electron-flags.conf'
    '.config/fastfetchTheme.jsonc'
    '.config/standard.omp.toml'
    '.config/starship.toml'
    '.config/xdg-terminals.list'

    # Stow-managed directories (other modules - symlinked entirely)
    '.config/alacritty'
    '.config/fish'
    '.config/foot'
    '.config/ghostty'
    '.config/hypr'
    '.config/kitty'
    '.config/mpv'
    '.config/niri'
    '.config/nushell'
    '.config/nvim'
    '.config/quickshell'
    '.config/swayidle'
    '.config/swaylock'
    '.config/swaync'
    '.config/swayosd'
    '.config/waybar'
    '.config/wezterm'
    '.local/bin'

    # Additional app runtime caches
    'node-versions'
    'Shared Dictionary'
    'audio_cache'
    'media_cache'
)

RSYNC_ARGS=(
    -avh
    --relative
)

for exc in "${EXCLUDES[@]}"; do RSYNC_ARGS+=("--exclude=$exc"); done

if [[ "${1:-}" == "--restore" || "${1:-}" == "-r" ]]; then
    echo "Restoring from $BACKUP_DIR to ~..."
    cd "$BACKUP_DIR" && rsync "${RSYNC_ARGS[@]}" . ~
else
    echo "Backing up ~ to $BACKUP_DIR..."
    mkdir -p "$BACKUP_DIR"
    cd ~ && rsync "${RSYNC_ARGS[@]}" --delete --delete-excluded . "$BACKUP_DIR/"
fi
